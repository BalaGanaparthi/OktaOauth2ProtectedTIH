<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2492px" preserveAspectRatio="none" style="width:1589px;height:2492px;background:#FFFFFF;" version="1.1" viewBox="0 0 1589 2492" width="1589px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="59.4648" id="_title" rx="3.5" ry="3.5" style="stroke:none;stroke-width:1.0;" width="423" x="579.25" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="788.25" y="28.5352"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="413" x="584.25" y="45.0234">Protect Token Inline Hook Service with Okta and OAuth2</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="788.25" y="61.5117"> </text><rect fill="#DDDDDD" height="2409.918" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="6" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="9" y="89.0332">Resource Owner</text><rect fill="#F08080" height="2409.918" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="110" x="221.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="257" y="89.0332">Client</text><rect fill="#87CEFA" height="2409.918" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="712.5" x="446.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="784.75" y="89.0332">Okta</text><rect fill="#F08080" height="2409.918" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="182" x="1171" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="176" x="1174" y="89.0332">Token Enrichment Service</text><rect fill="#F08080" height="2409.918" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="1428.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="1444.5" y="89.0332">Resource Servers</text><rect fill="#808080" height="1964.1465" style="stroke:#181818;stroke-width:1.0;" width="10" x="271.5" y="433.748"/><rect fill="#FFD700" height="1859.5703" style="stroke:#181818;stroke-width:1.0;" width="10" x="532.5" y="538.3242"/><rect fill="#FFD700" height="360.082" style="stroke:#181818;stroke-width:1.0;" width="10" x="879.5" y="1130.4023"/><rect fill="#808080" height="262.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="1257" y="1793.4355"/><rect fill="#808080" height="34" style="stroke:#181818;stroke-width:1.0;" width="10" x="1497.5" y="2363.8945"/><rect fill="none" height="1536.6191" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1452" x="36" y="643.7227"/><rect fill="none" height="669.4316" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="956" x="297" y="913.6738"/><rect fill="none" height="393.5273" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1037.5" x="440.5" y="1754.8145"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="64" x2="64" y1="172.2637" y2="2406.8945"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="276.5" x2="276.5" y1="172.2637" y2="2406.8945"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="537.5" x2="537.5" y1="172.2637" y2="2406.8945"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="884.5" x2="884.5" y1="172.2637" y2="2406.8945"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1107" x2="1107" y1="172.2637" y2="2406.8945"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1261.5" x2="1261.5" y1="172.2637" y2="2406.8945"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1502.5" x2="1502.5" y1="172.2637" y2="2406.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="46" y="169.3105">User</text><ellipse cx="64.5" cy="104.2754" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M64.5,112.2754 L64.5,139.2754 M51.5,120.2754 L77.5,120.2754 M64.5,139.2754 L51.5,154.2754 M64.5,139.2754 L77.5,154.2754 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="46" y="2419.4297">User</text><ellipse cx="64.5" cy="2430.8828" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M64.5,2438.8828 L64.5,2465.8828 M51.5,2446.8828 L77.5,2446.8828 M64.5,2465.8828 L51.5,2480.8828 M64.5,2465.8828 L77.5,2480.8828 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="235.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="242.5" y="161.3105">ClientApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="235.5" y="2405.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="242.5" y="2426.4297">ClientApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="154" x="460.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="140" x="467.5" y="161.3105">EndUser_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="154" x="460.5" y="2405.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="140" x="467.5" y="2426.4297">EndUser_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="130" x="819.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="826.5" y="161.3105">M2M_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="130" x="819.5" y="2405.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="826.5" y="2426.4297">M2M_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="1070" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1077" y="161.3105">M2MApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="1070" y="2405.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1077" y="2426.4297">M2MApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="1209.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1216.5" y="161.3105">TokenService</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="1209.5" y="2405.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1216.5" y="2426.4297">TokenService</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="120" x="1442.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="1449.5" y="161.3105">ResourceServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="120" x="1442.5" y="2405.8945"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="1449.5" y="2426.4297">ResourceServer</text><rect fill="#808080" height="1964.1465" style="stroke:#181818;stroke-width:1.0;" width="10" x="271.5" y="433.748"/><rect fill="#FFD700" height="1859.5703" style="stroke:#181818;stroke-width:1.0;" width="10" x="532.5" y="538.3242"/><rect fill="#FFD700" height="360.082" style="stroke:#181818;stroke-width:1.0;" width="10" x="879.5" y="1130.4023"/><rect fill="#808080" height="262.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="1257" y="1793.4355"/><rect fill="#808080" height="34" style="stroke:#181818;stroke-width:1.0;" width="10" x="1497.5" y="2363.8945"/><path d="M22,215.7637 L22,309.7637 A3.5,3.5 0 0 0 25.5,313.2637 L1539.5,313.2637 A3.5,3.5 0 0 0 1543,309.7637 L1543,222.2637 L1533,212.2637 L25.5,212.2637 A3.5,3.5 0 0 0 22,215.7637 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1533,212.2637 L1533,220.5137 A1.75,1.75 0 0 0 1534.75,222.2637 L1543,222.2637 L1533,212.2637 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="735.25" y="229.832">[</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="38" x="739.25" y="229.832">Setup</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="777.25" y="229.832">]</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="447.25" y="245.1426">M2MApp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="512.25" y="245.1426">: Configured with client creds grant w/</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="159" x="760.25" y="245.1426">Public key / Private key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="923.25" y="245.1426">for Client authentication</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="447.25" y="260.4531">M2MApp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="390" x="512.25" y="260.4531">: Not assigned to any users (Configured as Internal-Only App)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="447.25" y="275.7637">(</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="451.25" y="275.7637">M2M = Machine to Machine</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="624.25" y="275.7637">)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90" x="447.25" y="291.0742">TokenService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="557" x="541.25" y="291.0742">: Configured with OAuth 2.0 Authentication and Client Authentication as Use private key</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90" x="447.25" y="306.3848">TokenService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="541.25" y="306.3848">: Whitelist Okta CIDR ranges (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="378" x="727.25" y="306.3848">https://s3.amazonaws.com/okta-ip-ranges/ip_ranges.json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1105.25" y="306.3848">)</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1582.5" x="0" y="364.7822"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1582.5" y1="364.7822" y2="364.7822"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1582.5" y1="367.7822" y2="367.7822"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="276" x="653.25" y="354.127"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="262" x="659.25" y="370.6953">User Authentication and Authorization</text><ellipse cx="64" cy="432.998" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="259.5,429.748,269.5,433.748,259.5,437.748,263.5,433.748" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="68.5" x2="265.5" y1="433.748" y2="433.748"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="110.5" y="429.0059">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="123.5" y="429.0059">Access resource</text><path d="M142,450.248 L142,483.248 A3.5,3.5 0 0 0 145.5,486.748 L407.5,486.748 A3.5,3.5 0 0 0 411,483.248 L411,456.748 L401,446.748 L145.5,446.748 A3.5,3.5 0 0 0 142,450.248 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M401,446.748 L401,454.998 A1.75,1.75 0 0 0 402.75,456.748 L411,456.748 L401,446.748 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="148" y="463.8149">Access protected</text><text fill="#808080" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="112" x="284" y="463.8149">ResourceServer</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="224" x="148" y="478.9478">from client w/o access-token</text><polygon fill="#181818" points="520.5,534.3242,530.5,538.3242,520.5,542.3242,524.5,538.3242" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="538.3242" y2="538.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="367.5" y="533.582">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="380.5" y="533.582">/authorize</text><path d="M383,554.8242 L383,602.8242 A3.5,3.5 0 0 0 386.5,606.3242 L688.5,606.3242 A3.5,3.5 0 0 0 692,602.8242 L692,561.3242 L682,551.3242 L386.5,551.3242 A3.5,3.5 0 0 0 383,554.8242 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M682,551.3242 L682,559.5742 A1.75,1.75 0 0 0 683.75,561.3242 L692,561.3242 L682,551.3242 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="288" x="389" y="568.3911">Authorization code grant w/ PKCE(CC)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="389" y="583.5239">w/ ClientSPApp clientID</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="232" x="389" y="598.6567">w/ Resource Server scopes ...</text><path d="M39.5,643.7227 L189,643.7227 L189,651.0332 L179,661.0332 L36,661.0332 L36,647.2227 A3.5,3.5 0 0 1 39.5,643.7227 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1536.6191" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1452" x="36" y="643.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="51" y="657.291">No Okta Session</text><polygon fill="#181818" points="292.5,661.0332,282.5,665.0332,292.5,669.0332,288.5,665.0332" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="665.0332" y2="665.0332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="293.5" y="678.6016">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="306.5" y="678.6016">Prompt authN (optionally w/ MFA)</text><ellipse cx="64" cy="710.9043" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="259.5,707.6543,269.5,711.6543,259.5,715.6543,263.5,711.6543" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="68.5" x2="265.5" y1="711.6543" y2="711.6543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="94.5" y="706.9121">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="107.5" y="706.9121">Response to prompts</text><path d="M162,728.1543 L162,776.1543 A3.5,3.5 0 0 0 165.5,779.6543 L387.5,779.6543 A3.5,3.5 0 0 0 391,776.1543 L391,734.6543 L381,724.6543 L165.5,724.6543 A3.5,3.5 0 0 0 162,728.1543 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M381,724.6543 L381,732.9043 A1.75,1.75 0 0 0 382.75,734.6543 L391,734.6543 L381,724.6543 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="168" y="741.7212">Respond to authN (+ MFA) &amp;</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="168" y="756.854">any required consents from</text><text fill="#808080" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="144" x="168" y="771.9868">EndUser_AuthServer</text><polygon fill="#181818" points="520.5,827.3633,530.5,831.3633,520.5,835.3633,524.5,831.3633" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="831.3633" y2="831.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="315" y="826.6211">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="328" y="826.6211">AuthN &amp; AuthZ response(s)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="860.6738" y2="860.6738"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="860.6738" y2="873.6738"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="873.6738" y2="873.6738"/><polygon fill="#181818" points="553.5,869.6738,543.5,873.6738,553.5,877.6738,549.5,873.6738" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="549.5" y="855.9316">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237" x="562.5" y="855.9316">check for m2m access token in cache</text><path d="M300.5,913.6738 L555,913.6738 L555,920.9844 L545,930.9844 L297,930.9844 L297,917.1738 A3.5,3.5 0 0 1 300.5,913.6738 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="669.4316" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="956" x="297" y="913.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="213" x="312" y="927.2422">m2m Access token not in cache</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="542.5" x2="584.5" y1="952.2949" y2="952.2949"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="584.5" x2="584.5" y1="952.2949" y2="965.2949"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="543.5" x2="584.5" y1="965.2949" y2="965.2949"/><polygon fill="#181818" points="553.5,961.2949,543.5,965.2949,553.5,969.2949,549.5,965.2949" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="549.5" y="947.5527">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="562.5" y="947.5527">generate client_assertion and sign w/ private key</text><path d="M351,981.7949 L351,1074.7949 A3.5,3.5 0 0 0 354.5,1078.2949 L720.5,1078.2949 A3.5,3.5 0 0 0 724,1074.7949 L724,988.2949 L714,978.2949 L354.5,978.2949 A3.5,3.5 0 0 0 351,981.7949 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M714,978.2949 L714,986.5449 A1.75,1.75 0 0 0 715.75,988.2949 L724,988.2949 L714,978.2949 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="357" y="995.3618">Create JWT and Sign w\ Private Key</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1010.4946">aud</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="320" x="389" y="1010.4946">: EndUser_AuthServer's (token?) endpoint</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1025.6274">iss</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="389" y="1025.6274">: M2MApp client_id</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1040.7603">sub</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="389" y="1040.7603">: M2MApp client_id</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1055.8931">exp</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="389" y="1055.8931">: token's TTL (max 60mins)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="357" y="1071.0259">...</text><polygon fill="#181818" points="867.5,1126.4023,877.5,1130.4023,867.5,1134.4023,871.5,1130.4023" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="873.5" y1="1130.4023" y2="1130.4023"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="563.5" y="1125.6602">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="576.5" y="1125.6602">/token (client_creds with configured scopes)</text><path d="M307,1146.9023 L307,1239.9023 A3.5,3.5 0 0 0 310.5,1243.4023 L764.5,1243.4023 A3.5,3.5 0 0 0 768,1239.9023 L768,1153.4023 L758,1143.4023 L310.5,1143.4023 A3.5,3.5 0 0 0 307,1146.9023 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M758,1143.4023 L758,1151.6523 A1.75,1.75 0 0 0 759.75,1153.4023 L768,1153.4023 L758,1143.4023 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="312" x="313" y="1160.4692">Invoke /token with the following params</text><text fill="#0000FF" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="80" x="313" y="1175.6021">grant_type</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="401" y="1175.6021">:</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="144" x="417" y="1175.6021">client_credentials</text><text fill="#0000FF" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="168" x="313" y="1190.7349">client_assertion_type</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="489" y="1190.7349">:</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="313" y="1205.8677"> </text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="432" x="321" y="1205.8677">urn:ietf:params:oauth:client-assertion-type:jwt-bearer</text><text fill="#0000FF" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="128" x="313" y="1221.0005">client_assertion</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="449" y="1221.0005">:</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="96" x="465" y="1221.0005">{Signed JWT}</text><text fill="#0000FF" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="40" x="313" y="1236.1333">scope</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="361" y="1236.1333">:</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="136" x="377" y="1236.1333">configured scopes</text><ellipse cx="1107" cy="1269.7598" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="1090,1266.5098,1100,1270.5098,1090,1274.5098,1094,1270.5098" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="889.5" x2="1096" y1="1270.5098" y2="1270.5098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="901.5" y="1265.7676">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="914.5" y="1265.7676">get pub key of sub (client id)</text><path d="M702,1287.0098 L702,1335.0098 A3.5,3.5 0 0 0 705.5,1338.5098 L1063.5,1338.5098 A3.5,3.5 0 0 0 1067,1335.0098 L1067,1293.5098 L1057,1283.5098 L705.5,1283.5098 A3.5,3.5 0 0 0 702,1287.0098 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1057,1283.5098 L1057,1291.7598 A1.75,1.75 0 0 0 1058.75,1293.5098 L1067,1293.5098 L1057,1283.5098 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="708" y="1300.5767">Get the client_id (sub) in JWT and</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="708" y="1315.7095">Get KID of public key configured of the app</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="708" y="1330.8423">correcponding to client_id</text><line style="stroke:#181818;stroke-width:1.0;" x1="889.5" x2="931.5" y1="1390.2188" y2="1390.2188"/><line style="stroke:#181818;stroke-width:1.0;" x1="931.5" x2="931.5" y1="1390.2188" y2="1403.2188"/><line style="stroke:#181818;stroke-width:1.0;" x1="890.5" x2="931.5" y1="1403.2188" y2="1403.2188"/><polygon fill="#181818" points="900.5,1399.2188,890.5,1403.2188,900.5,1407.2188,896.5,1403.2188" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="896.5" y="1385.4766">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="918.5" y="1385.4766">validate client_assertion</text><path d="M894,1419.7188 L894,1452.7188 A3.5,3.5 0 0 0 897.5,1456.2188 L1239.5,1456.2188 A3.5,3.5 0 0 0 1243,1452.7188 L1243,1426.2188 L1233,1416.2188 L897.5,1416.2188 A3.5,3.5 0 0 0 894,1419.7188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1233,1416.2188 L1233,1424.4688 A1.75,1.75 0 0 0 1234.75,1426.2188 L1243,1426.2188 L1233,1416.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="328" x="900" y="1433.2856">Validate the signed client_assertion with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="320" x="900" y="1448.4185">the public key of app matching client_id</text><polygon fill="#181818" points="553.5,1486.4844,543.5,1490.4844,553.5,1494.4844,549.5,1490.4844" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="883.5" y1="1490.4844" y2="1490.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="626.5" y="1504.0527">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="648.5" y="1504.0527">send m2m access token</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="1537.1055" y2="1537.1055"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="1537.1055" y2="1550.1055"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="1550.1055" y2="1550.1055"/><polygon fill="#181818" points="553.5,1546.1055,543.5,1550.1055,553.5,1554.1055,549.5,1550.1055" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="1532.3633">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240" x="571.5" y="1532.3633">cache m2m access token (ttl 60mins?)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="1636.416" y2="1636.416"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="1636.416" y2="1649.416"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="1649.416" y2="1649.416"/><polygon fill="#181818" points="553.5,1645.416,543.5,1649.416,553.5,1653.416,549.5,1649.416" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="1631.6738">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="571.5" y="1631.6738">generate policy based claims</text><path d="M359,1665.916 L359,1713.916 A3.5,3.5 0 0 0 362.5,1717.416 L712.5,1717.416 A3.5,3.5 0 0 0 716,1713.916 L716,1672.416 L706,1662.416 L362.5,1662.416 A3.5,3.5 0 0 0 359,1665.916 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M706,1662.416 L706,1670.666 A1.75,1.75 0 0 0 707.75,1672.416 L716,1672.416 L706,1662.416 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="365" y="1679.4829">Claims are calculated based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="296" x="365" y="1694.6157">requested scopes and token enrichment</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="336" x="365" y="1709.7485">(if done) at the token inline hook service</text><path d="M444,1754.8145 L975.5,1754.8145 L975.5,1762.125 L965.5,1772.125 L440.5,1772.125 L440.5,1758.3145 A3.5,3.5 0 0 1 444,1754.8145 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="393.5273" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1037.5" x="440.5" y="1754.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="490" x="455.5" y="1768.3828">Successfully recieved m2m access token from M2M Authorization Server</text><polygon fill="#181818" points="1245,1789.4355,1255,1793.4355,1245,1797.4355,1249,1793.4355" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="1251" y1="1793.4355" y2="1793.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="741.25" y="1788.6934">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="763.25" y="1788.6934">invoke token endpoint with m2m access token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1267" x2="1309" y1="1822.7461" y2="1822.7461"/><line style="stroke:#181818;stroke-width:1.0;" x1="1309" x2="1309" y1="1822.7461" y2="1835.7461"/><line style="stroke:#181818;stroke-width:1.0;" x1="1268" x2="1309" y1="1835.7461" y2="1835.7461"/><polygon fill="#181818" points="1278,1831.7461,1268,1835.7461,1278,1839.7461,1274,1835.7461" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1274" y="1818.0039">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="1296" y="1818.0039">validate m2m token</text><path d="M1131,1852.2461 L1131,1900.2461 A3.5,3.5 0 0 0 1134.5,1903.7461 L1388.5,1903.7461 A3.5,3.5 0 0 0 1392,1900.2461 L1392,1858.7461 L1382,1848.7461 L1134.5,1848.7461 A3.5,3.5 0 0 0 1131,1852.2461 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1382,1848.7461 L1382,1856.9961 A1.75,1.75 0 0 0 1383.75,1858.7461 L1392,1858.7461 L1382,1848.7461 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="232" x="1137" y="1865.813">Validate m2m access token JWT</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="1137" y="1880.9458">locally at TokenService</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="168" x="1137" y="1896.0786">iss, aud, sub, scp...</text><line style="stroke:#181818;stroke-width:1.0;" x1="1267" x2="1309" y1="1955.4551" y2="1955.4551"/><line style="stroke:#181818;stroke-width:1.0;" x1="1309" x2="1309" y1="1955.4551" y2="1968.4551"/><line style="stroke:#181818;stroke-width:1.0;" x1="1268" x2="1309" y1="1968.4551" y2="1968.4551"/><polygon fill="#181818" points="1278,1964.4551,1268,1968.4551,1278,1972.4551,1274,1968.4551" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1274" y="1950.7129">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="1296" y="1950.7129">enrich (+ ~ -) token claims</text><path d="M1155,1984.9551 L1155,2017.9551 A3.5,3.5 0 0 0 1158.5,2021.4551 L1364.5,2021.4551 A3.5,3.5 0 0 0 1368,2017.9551 L1368,1991.4551 L1358,1981.4551 L1158.5,1981.4551 A3.5,3.5 0 0 0 1155,1984.9551 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1358,1981.4551 L1358,1989.7051 A1.75,1.75 0 0 0 1359.75,1991.4551 L1368,1991.4551 L1358,1981.4551 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="1161" y="1998.522">Allow Enrichment</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="192" x="1161" y="2013.6548">on successful validation</text><polygon fill="#181818" points="553.5,2051.7207,543.5,2055.7207,553.5,2059.7207,549.5,2055.7207" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1261" y1="2055.7207" y2="2055.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="836.75" y="2069.2891">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="858.75" y="2069.2891">enriched token(s)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="2102.3418" y2="2102.3418"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="2102.3418" y2="2115.3418"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="2115.3418" y2="2115.3418"/><polygon fill="#181818" points="553.5,2111.3418,543.5,2115.3418,553.5,2119.3418,549.5,2115.3418" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="2097.5996">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="571.5" y="2097.5996">create okta session for the user</text><polygon fill="#181818" points="292.5,2212.3418,282.5,2216.3418,292.5,2220.3418,288.5,2216.3418" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="2216.3418" y2="2216.3418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="322" y="2229.9102">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="344" y="2229.9102">respond with auth code</text><polygon fill="#181818" points="520.5,2258.9629,530.5,2262.9629,520.5,2266.9629,524.5,2262.9629" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="2262.9629" y2="2262.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="326" y="2258.2207">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="348" y="2258.2207">/token with auth code</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="2292.2734" y2="2292.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="2292.2734" y2="2305.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="2305.2734" y2="2305.2734"/><polygon fill="#181818" points="553.5,2301.2734,543.5,2305.2734,553.5,2309.2734,549.5,2305.2734" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="2287.5313">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="571.5" y="2287.5313">mint token(s) with enriched claims</text><polygon fill="#181818" points="292.5,2313.2734,282.5,2317.2734,292.5,2321.2734,288.5,2317.2734" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="2317.2734" y2="2317.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="338" y="2330.8418">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="360" y="2330.8418">send user token(s)</text><polygon fill="#181818" points="1485.5,2359.8945,1495.5,2363.8945,1485.5,2367.8945,1489.5,2363.8945" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="1491.5" y1="2363.8945" y2="2363.8945"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="734.5" y="2359.1523">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="756.5" y="2359.1523">Access Resource Server with the user token(s)</text><!--MD5=[7d16d972b25509de97b434843345fb75]
@startuml TokenEnrichment
skinparam ParticipantPadding 10
skinparam BoxPadding 5
skinparam roundcorner 7
autonumber
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title \n<u><b>Protect Token Inline Hook Service with Okta and OAuth2</b></u>\n

box "Resource Owner"  
    actor User as user
end box

box "Client" #f08080
    participant "ClientApp" as client 
end box

box "Okta " #LightSkyBlue 
    participant EndUser_AuthServer as eaz 
    participant M2M_AuthServer as maz
    participant M2MApp as ma
end box

box "Token Enrichment Service" #f08080
    participant TokenService as tkns
end box

box "Resource Servers" #f08080
    participant ResourceServer as rs
end box
|||| 
note across
    \t\t\t\t\t\t\t\t\t[<u>**Setup**</u>] 
    **M2MApp** : Configured with client creds grant w/ <b>Public key / Private key</b> for Client authentication
    **M2MApp** : Not assigned to any users (Configured as Internal-Only App)
    (<font color=blue>M2M = Machine to Machine</font>)
    **TokenService** : Configured with OAuth 2.0 Authentication and Client Authentication as Use private key
    **TokenService** : Whitelist Okta CIDR ranges (<i>https://s3.amazonaws.com/okta-ip-ranges/ip_ranges.json</i>)
end note
||||
==User Authentication and Authorization==
||||
user o-> client  ++ #Grey : Access resource
note over client
    ""Access protected <font color=Grey><i>ResourceServer</i></font>""
    ""from client w/o access-token""
end note
||||
client -> eaz ++ #gold : /authorize
note over eaz
    ""Authorization code grant w/ PKCE(CC)""
    ""w/ ClientSPApp clientID""
    ""w/ Resource Server scopes ...""
end note
||||
group  No Okta Session 
    eaz -> client : Prompt authN (optionally w/ MFA)
    user o-> client : Response to prompts
    note over client
        ""Respond to authN (+ MFA) &""
        ""any required consents from""
        ""<font color=Grey><i>EndUser_AuthServer</i></font>""
    end note
    ||||
    client -> eaz : AuthN & AuthZ response(s)
    eaz -> eaz : check for m2m access token in cache
    ||||
    group m2m Access token not in cache
        eaz - -> eaz  #Grey : generate client_assertion and sign w/ private key
        note over eaz
            ""Create JWT and Sign w\ Private Key""
            ""<i>aud</i> : EndUser_AuthServer's (token?) endpoint""
            ""<i>iss</i> : M2MApp client_id""
            ""<i>sub</i> : M2MApp client_id""
            ""<i>exp</i> : token's TTL (max 60mins)""
            ""...""
        end note
        ||||
        eaz -> maz ++ #gold: /token (client_creds with configured scopes)
        note over eaz
            ""Invoke /token with the following params""
            ""<font color=blue>grant_type</font> : <i>client_credentials</i>""
            ""<font color=blue>client_assertion_type</font> : ""
            "" <i>urn:ietf:params:oauth:client-assertion-type:jwt-bearer</i>""
            ""<font color=blue><i>client_assertion</font> : <i>{Signed JWT}</i>""
            ""<font color=blue>scope</font> : <i>configured scopes</i>""
        end note
        maz ->o ma : get pub key of sub (client id)
        note over maz
            ""Get the client_id (sub) in JWT and""
            ""Get KID of public key configured of the app""
            ""correcponding to client_id""
        end note
        ||||
        maz -> maz : validate client_assertion
        note right maz
            ""Validate the signed client_assertion with""
            ""the public key of app matching client_id""
        end note
        ||||
        maz -> eaz - - : send m2m access token
        eaz -> eaz : cache m2m access token (ttl 60mins?)
        ||||
    end
    ||||
    eaz -> eaz : generate policy based claims
    note over eaz
        ""Claims are calculated based on""
        ""requested scopes and token enrichment""
        ""(if done) at the token inline hook service""
    end note
    ||||
    group Successfully recieved m2m access token from M2M Authorization Server
        eaz -> tkns ++ #Grey: invoke token endpoint with m2m access token
        tkns -> tkns : validate m2m token
        note over tkns
            ""Validate m2m access token JWT ""
            ""locally at TokenService""
            ""<i>iss, aud, sub, scp...</i>""
        end note
        ||||
        tkns -> tkns : enrich (+ ~ -) token claims
        note over tkns
            ""Allow Enrichment""
            ""on successful validation""
        end note
        ||||
        tkns -> eaz - - : enriched token(s)
        eaz -> eaz : create okta session for the user
        ||||    
    end
    ||||
end
||||
eaz -> client : respond with auth code
client -> eaz : /token with auth code
eaz -> eaz : mint token(s) with enriched claims
eaz -> client : send user token(s)
client -> rs ++ #grey: Access Resource Server with the user token(s)
||||
@enduml

PlantUML version 1.2022.7(Mon Aug 22 12:01:30 CDT 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>