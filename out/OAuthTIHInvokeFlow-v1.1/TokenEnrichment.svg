<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2933px" preserveAspectRatio="none" style="width:1600px;height:2933px;background:#FFFFFF;" version="1.1" viewBox="0 0 1600 2933" width="1600px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="59.4648" id="_title" rx="3.5" ry="3.5" style="stroke:none;stroke-width:1.0;" width="584" x="504" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="793.5" y="28.5352"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="574" x="509" y="45.0234">Protect Token Inline Hook Service with Okta and OAuth2 with Private_Key_JWT</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="793.5" y="61.5117"> </text><rect fill="#DDDDDD" height="2851.4707" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="6" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="9" y="89.0332">Resource Owner</text><rect fill="#F08080" height="2851.4707" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="110" x="221.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="257" y="89.0332">Client</text><rect fill="#87CEFA" height="2851.4707" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="744" x="447.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="801.5" y="89.0332">Okta</text><rect fill="#F08080" height="2851.4707" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="180" x="1203.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="174" x="1206.5" y="89.0332">Token Inline Hook Service</text><rect fill="#F08080" height="2851.4707" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="1439" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="1455" y="89.0332">Resource Servers</text><rect fill="#808080" height="2405.6992" style="stroke:#181818;stroke-width:1.0;" width="10" x="271.5" y="433.748"/><rect fill="#FFD700" height="2301.123" style="stroke:#181818;stroke-width:1.0;" width="10" x="532.5" y="538.3242"/><rect fill="#FFD700" height="360.082" style="stroke:#181818;stroke-width:1.0;" width="10" x="879.5" y="1317.0234"/><rect fill="#808080" height="262.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="1288.5" y="2073.3672"/><rect fill="#808080" height="34" style="stroke:#181818;stroke-width:1.0;" width="10" x="1508" y="2805.4473"/><rect fill="none" height="1816.5508" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1483.5" x="36" y="643.7227"/><rect fill="none" height="762.7422" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="904.5" x="293" y="1006.9844"/><rect fill="none" height="486.8379" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1068" x="441.5" y="1941.4355"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="64" x2="64" y1="172.2637" y2="2848.4473"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="276.5" x2="276.5" y1="172.2637" y2="2848.4473"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="537.5" x2="537.5" y1="172.2637" y2="2848.4473"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="884.5" x2="884.5" y1="172.2637" y2="2848.4473"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1107.5" x2="1107.5" y1="172.2637" y2="2848.4473"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1293" x2="1293" y1="172.2637" y2="2848.4473"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1513" x2="1513" y1="172.2637" y2="2848.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="46" y="169.3105">User</text><ellipse cx="64.5" cy="104.2754" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M64.5,112.2754 L64.5,139.2754 M51.5,120.2754 L77.5,120.2754 M64.5,139.2754 L51.5,154.2754 M64.5,139.2754 L77.5,154.2754 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="46" y="2860.9824">User</text><ellipse cx="64.5" cy="2872.4355" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M64.5,2880.4355 L64.5,2907.4355 M51.5,2888.4355 L77.5,2888.4355 M64.5,2907.4355 L51.5,2922.4355 M64.5,2907.4355 L77.5,2922.4355 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="235.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="242.5" y="161.3105">ClientApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="235.5" y="2847.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="242.5" y="2867.9824">ClientApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="461.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="468.5" y="161.3105">CVSApp_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="152" x="461.5" y="2847.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="468.5" y="2867.9824">CVSApp_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="130" x="819.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="826.5" y="161.3105">M2M_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="130" x="819.5" y="2847.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="826.5" y="2867.9824">M2M_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="140" x="1037.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126" x="1044.5" y="161.3105">M2MWebHookApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="140" x="1037.5" y="2847.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126" x="1044.5" y="2867.9824">M2MWebHookApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="1221" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="1228" y="161.3105">LoginHelperService</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="1221" y="2847.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="1228" y="2867.9824">LoginHelperService</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="120" x="1453" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="1460" y="161.3105">ResourceServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="120" x="1453" y="2847.4473"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="1460" y="2867.9824">ResourceServer</text><rect fill="#808080" height="2405.6992" style="stroke:#181818;stroke-width:1.0;" width="10" x="271.5" y="433.748"/><rect fill="#FFD700" height="2301.123" style="stroke:#181818;stroke-width:1.0;" width="10" x="532.5" y="538.3242"/><rect fill="#FFD700" height="360.082" style="stroke:#181818;stroke-width:1.0;" width="10" x="879.5" y="1317.0234"/><rect fill="#808080" height="262.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="1288.5" y="2073.3672"/><rect fill="#808080" height="34" style="stroke:#181818;stroke-width:1.0;" width="10" x="1508" y="2805.4473"/><path d="M22,215.7637 L22,309.7637 A3.5,3.5 0 0 0 25.5,313.2637 L1550.5,313.2637 A3.5,3.5 0 0 0 1554,309.7637 L1554,222.2637 L1544,212.2637 L25.5,212.2637 A3.5,3.5 0 0 0 22,215.7637 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1544,212.2637 L1544,220.5137 A1.75,1.75 0 0 0 1545.75,222.2637 L1554,222.2637 L1544,212.2637 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="690" y="229.832">[</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="38" x="694" y="229.832">Setup</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="732" y="229.832">]</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="124" x="402" y="245.1426">M2MWebHookApp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="530" y="245.1426">: Configured with</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="108" x="643" y="245.1426">client credentials</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="755" y="245.1426">grant-type w/</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="159" x="848" y="245.1426">Public key / Private key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="1011" y="245.1426">for Client authentication</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="124" x="402" y="260.4531">M2MWebHookApp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="505" x="530" y="260.4531">: Not assigned to any users (Configured to be used as Internal-Only Virtual App)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="402" y="275.7637">(</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="173" x="406" y="275.7637">M2M = Machine to Machine</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="579" y="275.7637">)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="131" x="402" y="291.0742">LoginHelperService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="613" x="537" y="291.0742">: Token Inline Hook Service protected with OAuth 2.0 Authorization issued from M2M_AuthServer</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="131" x="402" y="306.3848">LoginHelperService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="537" y="306.3848">: Whitelist Okta CIDR ranges (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="378" x="723" y="306.3848">https://s3.amazonaws.com/okta-ip-ranges/ip_ranges.json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1101" y="306.3848">)</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1593" x="0" y="364.7822"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="364.7822" y2="364.7822"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="367.7822" y2="367.7822"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="334" x="629.5" y="354.127"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="320" x="635.5" y="370.6953">Clent request for User Tokens from EndUser AS</text><ellipse cx="64" cy="432.998" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="259.5,429.748,269.5,433.748,259.5,437.748,263.5,433.748" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="68.5" x2="265.5" y1="433.748" y2="433.748"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="110.5" y="429.0059">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="123.5" y="429.0059">Access resource</text><path d="M142,450.248 L142,483.248 A3.5,3.5 0 0 0 145.5,486.748 L407.5,486.748 A3.5,3.5 0 0 0 411,483.248 L411,456.748 L401,446.748 L145.5,446.748 A3.5,3.5 0 0 0 142,450.248 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M401,446.748 L401,454.998 A1.75,1.75 0 0 0 402.75,456.748 L411,456.748 L401,446.748 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="148" y="463.8149">Access protected</text><text fill="#808080" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="112" x="284" y="463.8149">ResourceServer</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="224" x="148" y="478.9478">from client w/o access-token</text><polygon fill="#181818" points="520.5,534.3242,530.5,538.3242,520.5,542.3242,524.5,538.3242" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="538.3242" y2="538.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="367.5" y="533.582">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="380.5" y="533.582">/authorize</text><path d="M383,554.8242 L383,602.8242 A3.5,3.5 0 0 0 386.5,606.3242 L688.5,606.3242 A3.5,3.5 0 0 0 692,602.8242 L692,561.3242 L682,551.3242 L386.5,551.3242 A3.5,3.5 0 0 0 383,554.8242 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M682,551.3242 L682,559.5742 A1.75,1.75 0 0 0 683.75,561.3242 L692,561.3242 L682,551.3242 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="288" x="389" y="568.3911">Authorization code grant w/ PKCE(CC)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="389" y="583.5239">w/ ClientSPApp clientID</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="232" x="389" y="598.6567">w/ Resource Server scopes ...</text><path d="M39.5,643.7227 L189,643.7227 L189,651.0332 L179,661.0332 L36,661.0332 L36,647.2227 A3.5,3.5 0 0 1 39.5,643.7227 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1816.5508" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1483.5" x="36" y="643.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="51" y="657.291">No Okta Session</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1593" x="0" y="706.6885"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="706.6885" y2="706.6885"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="709.6885" y2="709.6885"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="276" x="658.5" y="696.0332"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="262" x="664.5" y="712.6016">User Authentication and Authorization</text><polygon fill="#181818" points="292.5,754.3438,282.5,758.3438,292.5,762.3438,288.5,758.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="758.3438" y2="758.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="293.5" y="771.9121">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="306.5" y="771.9121">Prompt authN (optionally w/ MFA)</text><ellipse cx="64" cy="804.2148" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="259.5,800.9648,269.5,804.9648,259.5,808.9648,263.5,804.9648" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="68.5" x2="265.5" y1="804.9648" y2="804.9648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="94.5" y="800.2227">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="107.5" y="800.2227">Response to prompts</text><path d="M162,821.4648 L162,869.4648 A3.5,3.5 0 0 0 165.5,872.9648 L387.5,872.9648 A3.5,3.5 0 0 0 391,869.4648 L391,827.9648 L381,817.9648 L165.5,817.9648 A3.5,3.5 0 0 0 162,821.4648 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M381,817.9648 L381,826.2148 A1.75,1.75 0 0 0 382.75,827.9648 L391,827.9648 L381,817.9648 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="168" y="835.0317">Respond to authN (+ MFA) &amp;</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="168" y="850.1646">any required consents from</text><text fill="#808080" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="144" x="168" y="865.2974">EndUser_AuthServer</text><polygon fill="#181818" points="520.5,920.6738,530.5,924.6738,520.5,928.6738,524.5,924.6738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="924.6738" y2="924.6738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="315" y="919.9316">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="328" y="919.9316">AuthN &amp; AuthZ response(s)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="953.9844" y2="953.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="953.9844" y2="966.9844"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="966.9844" y2="966.9844"/><polygon fill="#181818" points="553.5,962.9844,543.5,966.9844,553.5,970.9844,549.5,966.9844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="549.5" y="949.2422">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="237" x="562.5" y="949.2422">check for m2m access token in cache</text><path d="M296.5,1006.9844 L551,1006.9844 L551,1014.2949 L541,1024.2949 L293,1024.2949 L293,1010.4844 A3.5,3.5 0 0 1 296.5,1006.9844 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="762.7422" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="904.5" x="293" y="1006.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="213" x="308" y="1020.5527">m2m Access token not in cache</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1593" x="0" y="1069.9502"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="1069.9502" y2="1069.9502"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="1072.9502" y2="1072.9502"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="782" x="405.5" y="1059.2949"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="768" x="411.5" y="1075.8633">EndUser AS requests for machine to machine tokens from M2M AS using private-key signed jwt/client_assertions</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="542.5" x2="584.5" y1="1138.916" y2="1138.916"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="584.5" x2="584.5" y1="1138.916" y2="1151.916"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="543.5" x2="584.5" y1="1151.916" y2="1151.916"/><polygon fill="#181818" points="553.5,1147.916,543.5,1151.916,553.5,1155.916,549.5,1151.916" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="549.5" y="1134.1738">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="562.5" y="1134.1738">generate client_assertion and sign w/ private key</text><path d="M351,1168.416 L351,1261.416 A3.5,3.5 0 0 0 354.5,1264.916 L720.5,1264.916 A3.5,3.5 0 0 0 724,1261.416 L724,1174.916 L714,1164.916 L354.5,1164.916 A3.5,3.5 0 0 0 351,1168.416 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M714,1164.916 L714,1173.166 A1.75,1.75 0 0 0 715.75,1174.916 L724,1174.916 L714,1164.916 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="357" y="1181.9829">Create JWT and Sign w\ Private Key</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1197.1157">aud</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="320" x="389" y="1197.1157">: EndUser_AuthServer's (token?) endpoint</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1212.2485">iss</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="389" y="1212.2485">: M2MApp client_id</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1227.3813">sub</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="389" y="1227.3813">: M2MApp client_id</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="1242.5142">exp</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="389" y="1242.5142">: token's TTL (max 60mins)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="357" y="1257.647">...</text><polygon fill="#181818" points="867.5,1313.0234,877.5,1317.0234,867.5,1321.0234,871.5,1317.0234" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="873.5" y1="1317.0234" y2="1317.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="563.5" y="1312.2813">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="576.5" y="1312.2813">/token (client_creds with configured scopes)</text><path d="M303,1333.5234 L303,1426.5234 A3.5,3.5 0 0 0 306.5,1430.0234 L768.5,1430.0234 A3.5,3.5 0 0 0 772,1426.5234 L772,1340.0234 L762,1330.0234 L306.5,1330.0234 A3.5,3.5 0 0 0 303,1333.5234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M762,1330.0234 L762,1338.2734 A1.75,1.75 0 0 0 763.75,1340.0234 L772,1340.0234 L762,1330.0234 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="384" x="309" y="1347.0903">Invoke /token endpoint with the following params</text><text fill="#0000FF" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="80" x="309" y="1362.2231">grant_type</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="397" y="1362.2231">:</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="144" x="413" y="1362.2231">client_credentials</text><text fill="#0000FF" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="168" x="309" y="1377.356">client_assertion_type</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="485" y="1377.356">:</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="16" x="309" y="1392.4888">  </text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="432" x="325" y="1392.4888">urn:ietf:params:oauth:client-assertion-type:jwt-bearer</text><text fill="#0000FF" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="128" x="309" y="1407.6216">client_assertion</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="445" y="1407.6216">:</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="216" x="461" y="1407.6216">{Signed JWT w/ private-key}</text><text fill="#0000FF" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="40" x="309" y="1422.7544">scope</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="357" y="1422.7544">:</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="368" x="373" y="1422.7544">{w/ scopes configured during TIH registration}</text><ellipse cx="1107" cy="1456.3809" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="1090,1453.1309,1100,1457.1309,1090,1461.1309,1094,1457.1309" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="889.5" x2="1096" y1="1457.1309" y2="1457.1309"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="901.5" y="1452.3887">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="914.5" y="1452.3887">get pub key of sub (client id)</text><path d="M702,1473.6309 L702,1521.6309 A3.5,3.5 0 0 0 705.5,1525.1309 L1063.5,1525.1309 A3.5,3.5 0 0 0 1067,1521.6309 L1067,1480.1309 L1057,1470.1309 L705.5,1470.1309 A3.5,3.5 0 0 0 702,1473.6309 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1057,1470.1309 L1057,1478.3809 A1.75,1.75 0 0 0 1058.75,1480.1309 L1067,1480.1309 L1057,1470.1309 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="708" y="1487.1978">Get the client_id (sub) in JWT and</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="344" x="708" y="1502.3306">Get KID of public key configured of the app</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="708" y="1517.4634">correcponding to client_id</text><line style="stroke:#181818;stroke-width:1.0;" x1="889.5" x2="931.5" y1="1576.8398" y2="1576.8398"/><line style="stroke:#181818;stroke-width:1.0;" x1="931.5" x2="931.5" y1="1576.8398" y2="1589.8398"/><line style="stroke:#181818;stroke-width:1.0;" x1="890.5" x2="931.5" y1="1589.8398" y2="1589.8398"/><polygon fill="#181818" points="900.5,1585.8398,890.5,1589.8398,900.5,1593.8398,896.5,1589.8398" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="896.5" y="1572.0977">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="918.5" y="1572.0977">validate client_assertion</text><path d="M710,1606.3398 L710,1639.3398 A3.5,3.5 0 0 0 713.5,1642.8398 L1055.5,1642.8398 A3.5,3.5 0 0 0 1059,1639.3398 L1059,1612.8398 L1049,1602.8398 L713.5,1602.8398 A3.5,3.5 0 0 0 710,1606.3398 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1049,1602.8398 L1049,1611.0898 A1.75,1.75 0 0 0 1050.75,1612.8398 L1059,1612.8398 L1049,1602.8398 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="328" x="716" y="1619.9067">Validate the signed client_assertion with</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="320" x="716" y="1635.0396">the public key of app matching client_id</text><polygon fill="#181818" points="553.5,1673.1055,543.5,1677.1055,553.5,1681.1055,549.5,1677.1055" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="883.5" y1="1677.1055" y2="1677.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="626.5" y="1690.6738">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="648.5" y="1690.6738">send m2m access token</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="1723.7266" y2="1723.7266"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="1723.7266" y2="1736.7266"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="1736.7266" y2="1736.7266"/><polygon fill="#181818" points="553.5,1732.7266,543.5,1736.7266,553.5,1740.7266,549.5,1736.7266" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="1718.9844">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="240" x="571.5" y="1718.9844">cache m2m access token (ttl 60mins?)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="1823.0371" y2="1823.0371"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="1823.0371" y2="1836.0371"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="1836.0371" y2="1836.0371"/><polygon fill="#181818" points="553.5,1832.0371,543.5,1836.0371,553.5,1840.0371,549.5,1836.0371" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="1818.2949">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182" x="571.5" y="1818.2949">generate policy based claims</text><path d="M359,1852.5371 L359,1900.5371 A3.5,3.5 0 0 0 362.5,1904.0371 L712.5,1904.0371 A3.5,3.5 0 0 0 716,1900.5371 L716,1859.0371 L706,1849.0371 L362.5,1849.0371 A3.5,3.5 0 0 0 359,1852.5371 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M706,1849.0371 L706,1857.2871 A1.75,1.75 0 0 0 707.75,1859.0371 L716,1859.0371 L706,1849.0371 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="365" y="1866.104">Claims are calculated based on</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="296" x="365" y="1881.2368">requested scopes and token enrichment</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="336" x="365" y="1896.3696">(if done) at the token inline hook service</text><path d="M445,1941.4355 L976.5,1941.4355 L976.5,1948.7461 L966.5,1958.7461 L441.5,1958.7461 L441.5,1944.9355 A3.5,3.5 0 0 1 445,1941.4355 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="486.8379" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1068" x="441.5" y="1941.4355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="490" x="456.5" y="1955.0039">Successfully recieved m2m access token from M2M Authorization Server</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1593" x="0" y="2004.4014"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="2004.4014" y2="2004.4014"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="2007.4014" y2="2007.4014"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="494" x="549.5" y="1993.7461"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="480" x="555.5" y="2010.3145">EndUser AS executes token enrichment service with m2m access token</text><polygon fill="#181818" points="1276.5,2069.3672,1286.5,2073.3672,1276.5,2077.3672,1280.5,2073.3672" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="1282.5" y1="2073.3672" y2="2073.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="757" y="2068.625">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="779" y="2068.625">invoke token endpoint with m2m access token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1298.5" x2="1340.5" y1="2102.6777" y2="2102.6777"/><line style="stroke:#181818;stroke-width:1.0;" x1="1340.5" x2="1340.5" y1="2102.6777" y2="2115.6777"/><line style="stroke:#181818;stroke-width:1.0;" x1="1299.5" x2="1340.5" y1="2115.6777" y2="2115.6777"/><polygon fill="#181818" points="1309.5,2111.6777,1299.5,2115.6777,1309.5,2119.6777,1305.5,2115.6777" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1305.5" y="2097.9355">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="1327.5" y="2097.9355">validate m2m token</text><path d="M1163,2132.1777 L1163,2180.1777 A3.5,3.5 0 0 0 1166.5,2183.6777 L1420.5,2183.6777 A3.5,3.5 0 0 0 1424,2180.1777 L1424,2138.6777 L1414,2128.6777 L1166.5,2128.6777 A3.5,3.5 0 0 0 1163,2132.1777 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1414,2128.6777 L1414,2136.9277 A1.75,1.75 0 0 0 1415.75,2138.6777 L1424,2138.6777 L1414,2128.6777 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="232" x="1169" y="2145.7446">Validate m2m access token JWT</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="1169" y="2160.8774">locally at TokenService</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="168" x="1169" y="2176.0103">iss, aud, sub, scp...</text><line style="stroke:#181818;stroke-width:1.0;" x1="1298.5" x2="1340.5" y1="2235.3867" y2="2235.3867"/><line style="stroke:#181818;stroke-width:1.0;" x1="1340.5" x2="1340.5" y1="2235.3867" y2="2248.3867"/><line style="stroke:#181818;stroke-width:1.0;" x1="1299.5" x2="1340.5" y1="2248.3867" y2="2248.3867"/><polygon fill="#181818" points="1309.5,2244.3867,1299.5,2248.3867,1309.5,2252.3867,1305.5,2248.3867" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1305.5" y="2230.6445">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="1327.5" y="2230.6445">enrich (+ ~ -) token claims</text><path d="M1187,2264.8867 L1187,2297.8867 A3.5,3.5 0 0 0 1190.5,2301.3867 L1396.5,2301.3867 A3.5,3.5 0 0 0 1400,2297.8867 L1400,2271.3867 L1390,2261.3867 L1190.5,2261.3867 A3.5,3.5 0 0 0 1187,2264.8867 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1390,2261.3867 L1390,2269.6367 A1.75,1.75 0 0 0 1391.75,2271.3867 L1400,2271.3867 L1390,2261.3867 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="1193" y="2278.4536">Allow Enrichment</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="192" x="1193" y="2293.5864">on successful validation</text><polygon fill="#181818" points="553.5,2331.6523,543.5,2335.6523,553.5,2339.6523,549.5,2335.6523" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1292.5" y1="2335.6523" y2="2335.6523"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="852.5" y="2349.2207">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="874.5" y="2349.2207">enriched token(s)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="2382.2734" y2="2382.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="2382.2734" y2="2395.2734"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="2395.2734" y2="2395.2734"/><polygon fill="#181818" points="553.5,2391.2734,543.5,2395.2734,553.5,2399.2734,549.5,2395.2734" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="2377.5313">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="571.5" y="2377.5313">create okta session for the user</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1593" x="0" y="2512.9287"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="2512.9287" y2="2512.9287"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="2515.9287" y2="2515.9287"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="338" x="627.5" y="2502.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="324" x="633.5" y="2518.8418">OAuth2 flow to exchange code for (user) tokens</text><polygon fill="#181818" points="292.5,2560.584,282.5,2564.584,292.5,2568.584,288.5,2564.584" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="2564.584" y2="2564.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="322" y="2578.1523">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="344" y="2578.1523">respond with auth code</text><polygon fill="#181818" points="520.5,2607.2051,530.5,2611.2051,520.5,2615.2051,524.5,2611.2051" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="2611.2051" y2="2611.2051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="326" y="2606.4629">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="348" y="2606.4629">/token with auth code</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="2640.5156" y2="2640.5156"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="2640.5156" y2="2653.5156"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="2653.5156" y2="2653.5156"/><polygon fill="#181818" points="553.5,2649.5156,543.5,2653.5156,553.5,2657.5156,549.5,2653.5156" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="2635.7734">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="571.5" y="2635.7734">mint token(s) with enriched claims</text><polygon fill="#181818" points="292.5,2661.5156,282.5,2665.5156,292.5,2669.5156,288.5,2665.5156" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="2665.5156" y2="2665.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="338" y="2679.084">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="360" y="2679.084">send user token(s)</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1593" x="0" y="2736.4814"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="2736.4814" y2="2736.4814"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1593" y1="2739.4814" y2="2739.4814"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="441" x="576" y="2725.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="427" x="582" y="2742.3945">OAuth2 flow to access resource server with user's access token</text><polygon fill="#181818" points="1496,2801.4473,1506,2805.4473,1496,2809.4473,1500,2805.4473" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="1502" y1="2805.4473" y2="2805.4473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="739.75" y="2800.7051">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="761.75" y="2800.7051">Access Resource Server with the user token(s)</text><!--MD5=[a217cf340e90c829a2495cf050e438c3]
@startuml TokenEnrichment
skinparam ParticipantPadding 10
skinparam BoxPadding 5
skinparam roundcorner 7
autonumber
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title \n<u><b>Protect Token Inline Hook Service with Okta and OAuth2 with Private_Key_JWT</b></u>\n

box "Resource Owner"  
    actor User as user
end box

box "Client" #f08080
    participant "ClientApp" as client 
end box

box "Okta " #LightSkyBlue 
    participant CVSApp_AuthServer as eaz 
    participant M2M_AuthServer as maz
    participant M2MWebHookApp as ma
end box

box "Token Inline Hook Service" #f08080
    participant LoginHelperService as tkns
end box

box "Resource Servers" #f08080
    participant ResourceServer as rs
end box
|||| 
note across
    \t\t\t\t\t\t\t\t\t[<u>**Setup**</u>] 
    **M2MWebHookApp** : Configured with <i>client credentials</i> grant-type w/ <b>Public key / Private key</b> for Client authentication
    **M2MWebHookApp** : Not assigned to any users (Configured to be used as Internal-Only Virtual App)
    (<font color=blue>M2M = Machine to Machine</font>)
    **LoginHelperService** : Token Inline Hook Service protected with OAuth 2.0 Authorization issued from M2M_AuthServer
    **LoginHelperService** : Whitelist Okta CIDR ranges (<i>https://s3.amazonaws.com/okta-ip-ranges/ip_ranges.json</i>)
end note
||||
==Clent request for User Tokens from EndUser AS==
||||
user o-> client  ++ #Grey : Access resource
note over client 
    ""Access protected <font color=Grey><i>ResourceServer</i></font>""
    ""from client w/o access-token""
end note
||||
client -> eaz ++ #gold : /authorize
note over eaz 
    ""Authorization code grant w/ PKCE(CC)""
    ""w/ ClientSPApp clientID""
    ""w/ Resource Server scopes ...""
end note
||||
group No Okta Session
||||
==User Authentication and Authorization==
||||
    eaz -> client : Prompt authN (optionally w/ MFA)
    user o-> client : Response to prompts
    note over client 
        ""Respond to authN (+ MFA) &""
        ""any required consents from""
        ""<font color=Grey><i>EndUser_AuthServer</i></font>""
    end note
    ||||
    client -> eaz : AuthN & AuthZ response(s)
    eaz -> eaz : check for m2m access token in cache
    ||||
    group m2m Access token not in cache
    ||||
    ==EndUser AS requests for machine to machine tokens from M2M AS using private-key signed jwt/client_assertions== 
    ||||
        eaz - -> eaz  #Grey : generate client_assertion and sign w/ private key
        note over eaz
            ""Create JWT and Sign w\ Private Key""
            ""<i>aud</i> : EndUser_AuthServer's (token?) endpoint""
            ""<i>iss</i> : M2MApp client_id""
            ""<i>sub</i> : M2MApp client_id""
            ""<i>exp</i> : token's TTL (max 60mins)""
            ""...""
        end note
        ||||
        eaz -> maz ++ #gold: /token (client_creds with configured scopes)
        note over eaz
            ""Invoke /token endpoint with the following params""
            ""<font color=blue>grant_type</font> : <i>client_credentials</i>""
            ""<font color=blue>client_assertion_type</font> : ""
            ""  <i>urn:ietf:params:oauth:client-assertion-type:jwt-bearer</i>""
            ""<font color=blue><i>client_assertion</font> : <i>{Signed JWT w/ private-key}</i>""
            ""<font color=blue>scope</font> : <i>{w/ scopes configured during TIH registration}</i>""
        end note
        maz ->o ma : get pub key of sub (client id)
        note over maz
            ""Get the client_id (sub) in JWT and""
            ""Get KID of public key configured of the app""
            ""correcponding to client_id""
        end note
        ||||
        maz -> maz : validate client_assertion
        note over maz
            ""Validate the signed client_assertion with""
            ""the public key of app matching client_id""
        end note
        ||||
        maz -> eaz - - : send m2m access token
        eaz -> eaz : cache m2m access token (ttl 60mins?)
        ||||
    end
    ||||
    eaz -> eaz : generate policy based claims
    note over eaz
        ""Claims are calculated based on""
        ""requested scopes and token enrichment""
        ""(if done) at the token inline hook service""
    end note
    ||||
    group Successfully recieved m2m access token from M2M Authorization Server
    ||||
    ==EndUser AS executes token enrichment service with m2m access token==
    ||||
        eaz -> tkns ++ #Grey: invoke token endpoint with m2m access token
        tkns -> tkns : validate m2m token
        note over tkns
            ""Validate m2m access token JWT ""
            ""locally at TokenService""
            ""<i>iss, aud, sub, scp...</i>""
        end note
        ||||
        tkns -> tkns : enrich (+ ~ -) token claims
        note over tkns
            ""Allow Enrichment""
            ""on successful validation""
        end note
        ||||
        tkns -> eaz - - : enriched token(s)
        eaz -> eaz : create okta session for the user
        ||||    
    end
    ||||
end
||||
==OAuth2 flow to exchange code for (user) tokens==
||||
eaz -> client : respond with auth code
client -> eaz : /token with auth code
eaz -> eaz : mint token(s) with enriched claims
eaz -> client : send user token(s)
||||
==OAuth2 flow to access resource server with user's access token==
||||
client -> rs ++ #grey: Access Resource Server with the user token(s)
||||
@enduml

PlantUML version 1.2022.7(Mon Aug 22 12:01:30 CDT 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>