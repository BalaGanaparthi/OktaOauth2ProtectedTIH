<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2072px" preserveAspectRatio="none" style="width:1564px;height:2072px;background:#FFFFFF;" version="1.1" viewBox="0 0 1564 2072" width="1564px" zoomAndPan="magnify"><defs/><g><rect fill="none" height="59.4648" id="_title" rx="3.5" ry="3.5" style="stroke:none;stroke-width:1.0;" width="423" x="566.75" y="10"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="775.75" y="28.5352"> </text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="413" x="571.75" y="45.0234">Protect Token Inline Hook Service with Okta and OAuth2</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="5" x="775.75" y="61.5117"> </text><rect fill="#DDDDDD" height="1989.6563" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="117" x="6" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="111" x="9" y="89.0332">Resource Owner</text><rect fill="#F08080" height="1989.6563" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="110" x="221.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="257" y="89.0332">Client</text><rect fill="#87CEFA" height="1989.6563" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="732.5" x="446.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="32" x="794.75" y="89.0332">Okta</text><rect fill="#F08080" height="1989.6563" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="182" x="1191" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="176" x="1194" y="89.0332">Token Enrichment Service</text><rect fill="#F08080" height="1989.6563" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="148" x="1403.5" y="76.4648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="116" x="1419.5" y="89.0332">Resource Servers</text><rect fill="#808080" height="1559.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="271.5" y="418.4375"/><rect fill="#FFD700" height="1454.6191" style="stroke:#181818;stroke-width:1.0;" width="10" x="532.5" y="523.0137"/><rect fill="#FFD700" height="360.082" style="stroke:#181818;stroke-width:1.0;" width="10" x="879.5" y="1023.4707"/><rect fill="#808080" height="262.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="1277" y="1430.1738"/><rect fill="#808080" height="34" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="1943.6328"/><rect fill="none" height="1131.668" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1417" x="36" y="628.4121"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="64" x2="64" y1="172.2637" y2="1986.6328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="276.5" x2="276.5" y1="172.2637" y2="1986.6328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="537.5" x2="537.5" y1="172.2637" y2="1986.6328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="884.5" x2="884.5" y1="172.2637" y2="1986.6328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1127" x2="1127" y1="172.2637" y2="1986.6328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1281.5" x2="1281.5" y1="172.2637" y2="1986.6328"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="1477.5" x2="1477.5" y1="172.2637" y2="1986.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="46" y="169.3105">User</text><ellipse cx="64.5" cy="104.2754" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M64.5,112.2754 L64.5,139.2754 M51.5,120.2754 L77.5,120.2754 M64.5,139.2754 L51.5,154.2754 M64.5,139.2754 L77.5,154.2754 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="46" y="1999.168">User</text><ellipse cx="64.5" cy="2010.6211" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M64.5,2018.6211 L64.5,2045.6211 M51.5,2026.6211 L77.5,2026.6211 M64.5,2045.6211 L51.5,2060.6211 M64.5,2045.6211 L77.5,2060.6211 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="235.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="242.5" y="161.3105">ClientApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="82" x="235.5" y="1985.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="68" x="242.5" y="2006.168">ClientApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="154" x="460.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="140" x="467.5" y="161.3105">EndUser_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="154" x="460.5" y="1985.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="140" x="467.5" y="2006.168">EndUser_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="130" x="819.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="826.5" y="161.3105">M2M_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="130" x="819.5" y="1985.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="116" x="826.5" y="2006.168">M2M_AuthServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="1090" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1097" y="161.3105">M2MApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="75" x="1090" y="1985.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1097" y="2006.168">M2MApp</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="1229.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1236.5" y="161.3105">TokenService</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="105" x="1229.5" y="1985.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1236.5" y="2006.168">TokenService</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="120" x="1417.5" y="140.7754"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="1424.5" y="161.3105">ResourceServer</text><rect fill="#E2E2F0" height="30.4883" rx="3.5" ry="3.5" style="stroke:#181818;stroke-width:0.5;" width="120" x="1417.5" y="1985.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="1424.5" y="2006.168">ResourceServer</text><rect fill="#808080" height="1559.1953" style="stroke:#181818;stroke-width:1.0;" width="10" x="271.5" y="418.4375"/><rect fill="#FFD700" height="1454.6191" style="stroke:#181818;stroke-width:1.0;" width="10" x="532.5" y="523.0137"/><rect fill="#FFD700" height="360.082" style="stroke:#181818;stroke-width:1.0;" width="10" x="879.5" y="1023.4707"/><rect fill="#808080" height="262.2852" style="stroke:#181818;stroke-width:1.0;" width="10" x="1277" y="1430.1738"/><rect fill="#808080" height="34" style="stroke:#181818;stroke-width:1.0;" width="10" x="1472.5" y="1943.6328"/><path d="M22,215.7637 L22,294.7637 A3.5,3.5 0 0 0 25.5,298.2637 L1514.5,298.2637 A3.5,3.5 0 0 0 1518,294.7637 L1518,222.2637 L1508,212.2637 L25.5,212.2637 A3.5,3.5 0 0 0 22,215.7637 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1508,212.2637 L1508,220.5137 A1.75,1.75 0 0 0 1509.75,222.2637 L1518,222.2637 L1508,212.2637 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="722.75" y="229.832">[</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="38" x="726.75" y="229.832">Setup</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="764.75" y="229.832">]</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="434.75" y="245.1426">M2MApp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="244" x="499.75" y="245.1426">: Configured with client creds grant w/</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="159" x="747.75" y="245.1426">Public key / Private key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="910.75" y="245.1426">for Client authentication</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="61" x="434.75" y="260.4531">M2MApp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="390" x="499.75" y="260.4531">: Not assigned to any users (Configured as Internal-Only App)</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90" x="434.75" y="275.7637">TokenService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="557" x="528.75" y="275.7637">: Configured with OAuth 2.0 Authentication and Client Authentication as Use private key</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="90" x="434.75" y="291.0742">TokenService</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="528.75" y="291.0742">: Whitelist Okta CIDR ranges (</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="378" x="714.75" y="291.0742">https://s3.amazonaws.com/okta-ip-ranges/ip_ranges.json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="4" x="1092.75" y="291.0742">)</text><rect fill="#EEEEEE" height="3" rx="3.5" ry="3.5" style="stroke:#EEEEEE;stroke-width:1.0;" width="1557.5" x="0" y="349.4717"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1557.5" y1="349.4717" y2="349.4717"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1557.5" y1="352.4717" y2="352.4717"/><rect fill="#EEEEEE" height="23.3105" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:2.0;" width="276" x="640.75" y="338.8164"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="262" x="646.75" y="355.3848">User Authentication and Authorization</text><ellipse cx="64" cy="417.6875" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="259.5,414.4375,269.5,418.4375,259.5,422.4375,263.5,418.4375" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="68.5" x2="265.5" y1="418.4375" y2="418.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="110.5" y="413.6953">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="123.5" y="413.6953">Access resource</text><path d="M142,434.9375 L142,467.9375 A3.5,3.5 0 0 0 145.5,471.4375 L407.5,471.4375 A3.5,3.5 0 0 0 411,467.9375 L411,441.4375 L401,431.4375 L145.5,431.4375 A3.5,3.5 0 0 0 142,434.9375 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M401,431.4375 L401,439.6875 A1.75,1.75 0 0 0 402.75,441.4375 L411,441.4375 L401,431.4375 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="148" y="448.5044">Access protected</text><text fill="#808080" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="112" x="284" y="448.5044">ResourceServer</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="224" x="148" y="463.6372">from client w/o access-token</text><polygon fill="#181818" points="520.5,519.0137,530.5,523.0137,520.5,527.0137,524.5,523.0137" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="523.0137" y2="523.0137"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="367.5" y="518.2715">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="66" x="380.5" y="518.2715">/authorize</text><path d="M383,539.5137 L383,587.5137 A3.5,3.5 0 0 0 386.5,591.0137 L688.5,591.0137 A3.5,3.5 0 0 0 692,587.5137 L692,546.0137 L682,536.0137 L386.5,536.0137 A3.5,3.5 0 0 0 383,539.5137 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M682,536.0137 L682,544.2637 A1.75,1.75 0 0 0 683.75,546.0137 L692,546.0137 L682,536.0137 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="288" x="389" y="553.0806">Authorization code grant w/ PKCE(CC)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="389" y="568.2134">w/ ClientSPApp clientID</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="232" x="389" y="583.3462">w/ Resource Server scopes ...</text><path d="M39.5,628.4121 L98,628.4121 L98,635.7227 L88,645.7227 L36,645.7227 L36,631.9121 A3.5,3.5 0 0 1 39.5,628.4121 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="1131.668" rx="3.5" ry="3.5" style="stroke:#000000;stroke-width:1.5;" width="1417" x="36" y="628.4121"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="51" y="641.9805">alt</text><a href="-" target="_top" title="-" xlink:actuate="onRequest" xlink:href="-" xlink:show="new" xlink:title="-" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="91" x="113" y="641.0469">No Okta Session</text></a><polygon fill="#181818" points="292.5,645.7227,282.5,649.7227,292.5,653.7227,288.5,649.7227" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="649.7227" y2="649.7227"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="293.5" y="663.291">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="306.5" y="663.291">Prompt authN (optionally w/ MFA)</text><ellipse cx="64" cy="695.5938" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="259.5,692.3438,269.5,696.3438,259.5,700.3438,263.5,696.3438" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="68.5" x2="265.5" y1="696.3438" y2="696.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="94.5" y="691.6016">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="107.5" y="691.6016">Response to prompts</text><path d="M162,712.8438 L162,760.8438 A3.5,3.5 0 0 0 165.5,764.3438 L387.5,764.3438 A3.5,3.5 0 0 0 391,760.8438 L391,719.3438 L381,709.3438 L165.5,709.3438 A3.5,3.5 0 0 0 162,712.8438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M381,709.3438 L381,717.5938 A1.75,1.75 0 0 0 382.75,719.3438 L391,719.3438 L381,709.3438 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="168" y="726.4106">Respond to authN (+ MFA) &amp;</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="168" y="741.5435">any required consents from</text><text fill="#808080" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="144" x="168" y="756.6763">EndUser_AuthServer</text><polygon fill="#181818" points="520.5,812.0527,530.5,816.0527,520.5,820.0527,524.5,816.0527" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="816.0527" y2="816.0527"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="315" y="811.3105">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="171" x="328" y="811.3105">AuthN &amp; AuthZ response(s)</text><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="542.5" x2="584.5" y1="845.3633" y2="845.3633"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="584.5" x2="584.5" y1="845.3633" y2="858.3633"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="543.5" x2="584.5" y1="858.3633" y2="858.3633"/><polygon fill="#181818" points="553.5,854.3633,543.5,858.3633,553.5,862.3633,549.5,858.3633" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="549.5" y="840.6211">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="310" x="562.5" y="840.6211">generate client_assertion and sign w/ private key</text><path d="M351,874.8633 L351,967.8633 A3.5,3.5 0 0 0 354.5,971.3633 L720.5,971.3633 A3.5,3.5 0 0 0 724,967.8633 L724,881.3633 L714,871.3633 L354.5,871.3633 A3.5,3.5 0 0 0 351,874.8633 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M714,871.3633 L714,879.6133 A1.75,1.75 0 0 0 715.75,881.3633 L724,881.3633 L714,871.3633 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="272" x="357" y="888.4302">Create JWT and Sign w\ Private Key</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="903.563">aud</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="320" x="389" y="903.563">: EndUser_AuthServer's (token?) endpoint</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="918.6958">iss</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="389" y="918.6958">: M2MApp client_id</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="933.8286">sub</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="144" x="389" y="933.8286">: M2MApp client_id</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="24" x="357" y="948.9614">exp</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="389" y="948.9614">: token's TTL (max 60mins)</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="24" x="357" y="964.0942">...</text><polygon fill="#181818" points="867.5,1019.4707,877.5,1023.4707,867.5,1027.4707,871.5,1023.4707" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="873.5" y1="1023.4707" y2="1023.4707"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="563.5" y="1018.7285">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="576.5" y="1018.7285">/token (client_creds with configured scopes)</text><path d="M291,1039.9707 L291,1132.9707 A3.5,3.5 0 0 0 294.5,1136.4707 L780.5,1136.4707 A3.5,3.5 0 0 0 784,1132.9707 L784,1046.4707 L774,1036.4707 L294.5,1036.4707 A3.5,3.5 0 0 0 291,1039.9707 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M774,1036.4707 L774,1044.7207 A1.75,1.75 0 0 0 775.75,1046.4707 L784,1046.4707 L774,1036.4707 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="312" x="297" y="1053.5376">Invoke /token with the following params</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="80" x="297" y="1068.6704">grant_type</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="160" x="385" y="1068.6704">: client_credentials</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="168" x="297" y="1083.8032">client_assertion_type</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="8" x="473" y="1083.8032">:</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="40" x="297" y="1098.936">     </text><text fill="#0000FF" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="432" x="337" y="1098.936">urn:ietf:params:oauth:client-assertion-type:jwt-bearer</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="128" x="297" y="1114.0688">client_assertion</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="112" x="433" y="1114.0688">: {Signed JWT}</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="40" x="297" y="1129.2017">scope</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="160" x="345" y="1129.2017">: coonfigured scopes</text><ellipse cx="1127" cy="1162.8281" fill="none" rx="4" ry="4" style="stroke:#181818;stroke-width:1.5;"/><polygon fill="#181818" points="1110,1159.5781,1120,1163.5781,1110,1167.5781,1114,1163.5781" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="889.5" x2="1116" y1="1163.5781" y2="1163.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="901.5" y="1158.8359">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="914.5" y="1158.8359">get pub key if the sub (client id)</text><path d="M718,1180.0781 L718,1228.0781 A3.5,3.5 0 0 0 721.5,1231.5781 L1047.5,1231.5781 A3.5,3.5 0 0 0 1051,1228.0781 L1051,1186.5781 L1041,1176.5781 L721.5,1176.5781 A3.5,3.5 0 0 0 718,1180.0781 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1041,1176.5781 L1041,1184.8281 A1.75,1.75 0 0 0 1042.75,1186.5781 L1051,1186.5781 L1041,1176.5781 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="240" x="724" y="1193.645">Get the client_id (sub) in JWT</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="312" x="724" y="1208.7778">Get KID of public configured in the app</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="208" x="724" y="1223.9106">correcponding to client_id</text><line style="stroke:#181818;stroke-width:1.0;" x1="889.5" x2="931.5" y1="1283.2871" y2="1283.2871"/><line style="stroke:#181818;stroke-width:1.0;" x1="931.5" x2="931.5" y1="1283.2871" y2="1296.2871"/><line style="stroke:#181818;stroke-width:1.0;" x1="890.5" x2="931.5" y1="1296.2871" y2="1296.2871"/><polygon fill="#181818" points="900.5,1292.2871,890.5,1296.2871,900.5,1300.2871,896.5,1296.2871" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="9" x="896.5" y="1278.5449">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="909.5" y="1278.5449">validate client_assertion</text><path d="M730,1312.7871 L730,1345.7871 A3.5,3.5 0 0 0 733.5,1349.2871 L1035.5,1349.2871 A3.5,3.5 0 0 0 1039,1345.7871 L1039,1319.2871 L1029,1309.2871 L733.5,1309.2871 A3.5,3.5 0 0 0 730,1312.7871 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1029,1309.2871 L1029,1317.5371 A1.75,1.75 0 0 0 1030.75,1319.2871 L1039,1319.2871 L1029,1309.2871 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="288" x="736" y="1326.354">Validate the signed client_assertion</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="192" x="736" y="1341.4868">/w the public key of app</text><polygon fill="#181818" points="553.5,1379.5527,543.5,1383.5527,553.5,1387.5527,549.5,1383.5527" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="883.5" y1="1383.5527" y2="1383.5527"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="626.5" y="1397.1211">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152" x="648.5" y="1397.1211">send m2m access token</text><polygon fill="#181818" points="1265,1426.1738,1275,1430.1738,1265,1434.1738,1269,1430.1738" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="1271" y1="1430.1738" y2="1430.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="751.25" y="1425.4316">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="773.25" y="1425.4316">invoke token endpoint with m2m access token</text><line style="stroke:#181818;stroke-width:1.0;" x1="1287" x2="1329" y1="1459.4844" y2="1459.4844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1329" x2="1329" y1="1459.4844" y2="1472.4844"/><line style="stroke:#181818;stroke-width:1.0;" x1="1288" x2="1329" y1="1472.4844" y2="1472.4844"/><polygon fill="#181818" points="1298,1468.4844,1288,1472.4844,1298,1476.4844,1294,1472.4844" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1294" y="1454.7422">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="125" x="1316" y="1454.7422">validate m2m token</text><path d="M1151,1488.9844 L1151,1536.9844 A3.5,3.5 0 0 0 1154.5,1540.4844 L1408.5,1540.4844 A3.5,3.5 0 0 0 1412,1536.9844 L1412,1495.4844 L1402,1485.4844 L1154.5,1485.4844 A3.5,3.5 0 0 0 1151,1488.9844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1402,1485.4844 L1402,1493.7344 A1.75,1.75 0 0 0 1403.75,1495.4844 L1412,1495.4844 L1402,1485.4844 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="232" x="1157" y="1502.5513">Validate m2m access token JWT</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="184" x="1157" y="1517.6841">locally at TokenService</text><text fill="#000000" font-family="monospace" font-size="13" font-style="italic" lengthAdjust="spacing" textLength="168" x="1157" y="1532.8169">iss, aud, sub, scp...</text><line style="stroke:#181818;stroke-width:1.0;" x1="1287" x2="1329" y1="1592.1934" y2="1592.1934"/><line style="stroke:#181818;stroke-width:1.0;" x1="1329" x2="1329" y1="1592.1934" y2="1605.1934"/><line style="stroke:#181818;stroke-width:1.0;" x1="1288" x2="1329" y1="1605.1934" y2="1605.1934"/><polygon fill="#181818" points="1298,1601.1934,1288,1605.1934,1298,1609.1934,1294,1605.1934" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="1294" y="1587.4512">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="1316" y="1587.4512">enrich token(s)</text><path d="M1175,1621.6934 L1175,1654.6934 A3.5,3.5 0 0 0 1178.5,1658.1934 L1384.5,1658.1934 A3.5,3.5 0 0 0 1388,1654.6934 L1388,1628.1934 L1378,1618.1934 L1178.5,1618.1934 A3.5,3.5 0 0 0 1175,1621.6934 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M1378,1618.1934 L1378,1626.4434 A1.75,1.75 0 0 0 1379.75,1628.1934 L1388,1628.1934 L1378,1618.1934 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="128" x="1181" y="1635.2603">Allow Enrichment</text><text fill="#000000" font-family="monospace" font-size="13" lengthAdjust="spacing" textLength="192" x="1181" y="1650.3931">on successful validation</text><polygon fill="#181818" points="553.5,1688.459,543.5,1692.459,553.5,1696.459,549.5,1692.459" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="547.5" x2="1281" y1="1692.459" y2="1692.459"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="846.75" y="1706.0273">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="868.75" y="1706.0273">enriched token(s)</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="1739.0801" y2="1739.0801"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="1739.0801" y2="1752.0801"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="1752.0801" y2="1752.0801"/><polygon fill="#181818" points="553.5,1748.0801,543.5,1752.0801,553.5,1756.0801,549.5,1752.0801" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="1734.3379">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199" x="571.5" y="1734.3379">create okta session for the user</text><polygon fill="#181818" points="292.5,1792.0801,282.5,1796.0801,292.5,1800.0801,288.5,1796.0801" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="1796.0801" y2="1796.0801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="322" y="1809.6484">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="148" x="344" y="1809.6484">respond with auth code</text><polygon fill="#181818" points="520.5,1838.7012,530.5,1842.7012,520.5,1846.7012,524.5,1842.7012" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="526.5" y1="1842.7012" y2="1842.7012"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="326" y="1837.959">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="348" y="1837.959">/token with auth code</text><line style="stroke:#181818;stroke-width:1.0;" x1="542.5" x2="584.5" y1="1872.0117" y2="1872.0117"/><line style="stroke:#181818;stroke-width:1.0;" x1="584.5" x2="584.5" y1="1872.0117" y2="1885.0117"/><line style="stroke:#181818;stroke-width:1.0;" x1="543.5" x2="584.5" y1="1885.0117" y2="1885.0117"/><polygon fill="#181818" points="553.5,1881.0117,543.5,1885.0117,553.5,1889.0117,549.5,1885.0117" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="549.5" y="1867.2695">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="218" x="571.5" y="1867.2695">mint token(s) with enriched claims</text><polygon fill="#181818" points="292.5,1893.0117,282.5,1897.0117,292.5,1901.0117,288.5,1897.0117" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="531.5" y1="1897.0117" y2="1897.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="338" y="1910.5801">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="360" y="1910.5801">send user token(s)</text><polygon fill="#181818" points="1460.5,1939.6328,1470.5,1943.6328,1460.5,1947.6328,1464.5,1943.6328" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="281.5" x2="1466.5" y1="1943.6328" y2="1943.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="18" x="722" y="1938.8906">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="288" x="744" y="1938.8906">Access Resource Server with the user token(s)</text><!--MD5=[a7a56c75349a03e5a005d152aa75e7b3]
@startuml TokenEnrichment
skinparam ParticipantPadding 10
skinparam BoxPadding 5
skinparam roundcorner 7
autonumber
skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title \n<u><b>Protect Token Inline Hook Service with Okta and OAuth2</b></u>\n

box "Resource Owner"  
    actor User as user
end box

box "Client" #f08080
    participant "ClientApp" as client 
end box

box "Okta " #LightSkyBlue 
    participant EndUser_AuthServer as eaz 
    participant M2M_AuthServer as maz
    participant M2MApp as ma
end box

box "Token Enrichment Service" #f08080
    participant TokenService as tkns
end box

box "Resource Servers" #f08080
    participant ResourceServer as rs
end box
||||
note across
    \t\t\t\t\t\t\t\t\t[<u>**Setup**</u>] 
    **M2MApp** : Configured with client creds grant w/ <b>Public key / Private key</b> for Client authentication
    **M2MApp** : Not assigned to any users (Configured as Internal-Only App)
    **TokenService** : Configured with OAuth 2.0 Authentication and Client Authentication as Use private key
    **TokenService** : Whitelist Okta CIDR ranges (<i>https://s3.amazonaws.com/okta-ip-ranges/ip_ranges.json</i>)
end note
||||
==User Authentication and Authorization==
||||
user o-> client  ++ #Grey : Access resource
note over client
    ""Access protected <font color=Grey><i>ResourceServer</i></font>""
    ""from client w/o access-token""
end note
||||
client -> eaz ++ #gold : /authorize
note over eaz
    ""Authorization code grant w/ PKCE(CC)""
    ""w/ ClientSPApp clientID""
    ""w/ Resource Server scopes ...""
end note
||||
alt [ - No Okta Session ]
    eaz -> client : Prompt authN (optionally w/ MFA)
    user o-> client : Response to prompts
    note over client
        ""Respond to authN (+ MFA) &""
        ""any required consents from""
        ""<font color=Grey><i>EndUser_AuthServer</i></font>""
    end note
    ||||
    client -> eaz : AuthN & AuthZ response(s)
    eaz - -> eaz  #Grey : generate client_assertion and sign w/ private key
    note over eaz
        ""Create JWT and Sign w\ Private Key""
        ""<i>aud</i> : EndUser_AuthServer's (token?) endpoint""
        ""<i>iss</i> : M2MApp client_id""
        ""<i>sub</i> : M2MApp client_id""
        ""<i>exp</i> : token's TTL (max 60mins)""
        ""...""
    end note
    ||||
    eaz -> maz ++ #gold: /token (client_creds with configured scopes)
    note over eaz
        ""Invoke /token with the following params""
        ""<i>grant_type</i> : client_credentials""
        ""<i>client_assertion_type</i> : ""
        ""     <font color=blue><i>urn:ietf:params:oauth:client-assertion-type:jwt-bearer</i></font>""
        ""<i>client_assertion</i> : {Signed JWT}""
        ""<i>scope</i> : coonfigured scopes""
    end note
    maz ->o ma : get pub key if the sub (client id)
    note over maz
        ""Get the client_id (sub) in JWT""
        ""Get KID of public configured in the app""
        ""correcponding to client_id""
    end note
    |||
    maz -> maz : validate client_assertion
    note over maz
        ""Validate the signed client_assertion""
        ""/w the public key of app""
    end note
    |||
    maz -> eaz - - : send m2m access token
    eaz -> tkns ++ #Grey: invoke token endpoint with m2m access token
    tkns -> tkns : validate m2m token
    note over tkns
        ""Validate m2m access token JWT ""
        ""locally at TokenService""
        ""<i>iss, aud, sub, scp...</i>""
    end note
    ||||
    tkns -> tkns : enrich token(s)
    note over tkns
        ""Allow Enrichment""
        ""on successful validation""
    end note
    ||||
    tkns -> eaz - - : enriched token(s)
    eaz -> eaz : create okta session for the user
end
||||
eaz -> client : respond with auth code
client -> eaz : /token with auth code
eaz -> eaz : mint token(s) with enriched claims
eaz -> client : send user token(s)
client -> rs ++ #grey: Access Resource Server with the user token(s)
||||
@enduml

PlantUML version 1.2022.7(Mon Aug 22 12:01:30 CDT 2022)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>